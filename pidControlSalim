// Power enables left and right motors.
#define pinWheelREnable 5
#define pinWheelLEnable 6
//Motor A LHS
#define motorL1   10    //  IN4                        // Defines forward motion pin for left motor.
#define motorL2   9     //  IN3                        // Defines back motion pin for left motor.
//Motor B RHS
#define motorR1   8    //     IN1                     // Defines forward motion pin for right motor.
#define motorR2   3     //    IN2                      // Defines back motion pin for right motor.
float mspeed;

float Gyr_rawY;                                    //Y is Pitch
float elapsedTime, time, timePrev;
float desired_angle = 0;                          //set the mid point of where the robot is stationary  
float setpoint;

float PID, error, previous_error;
float pid_p;
float pid_i;
float pid_d;

float kp=100;
float ki=0;
float kd=200;

float a, b;

void setup() {
  
    Serial.begin(9600);
  
    pinMode(motorL1, OUTPUT);
    pinMode(motorL2, OUTPUT);
    pinMode(motorR1, OUTPUT);
    pinMode(motorR2, OUTPUT);
   

    time = millis();
}

void loop() {
  
    timePrev = time;  
    time = millis();  
    elapsedTime = (time - timePrev); 
 
       
    Gyr_rawY = analogRead(A0);
    //Serial.println(analogRead(A0));
    setpoint = 500;
    a = Gyr_rawY - setpoint;
    b = abs(a)+setpoint;
  
    error = setpoint - desired_angle;                       //ERROR CALCULATION
    //Serial.println(setpoint);
    pid_p = kp*error;                                       //PROPORTIONAL ERROR
    pid_i = pid_i+(ki*error);                               //INTERGRAL ERROR 
    pid_d = kd*((error - previous_error)/elapsedTime);      //DIFFERENTIAL ERROR
    PID = (pid_p + pid_d)/100;                                //TOTAL PID VALUE
    Serial.print("PID value:     ");
    Serial.println(PID);
    previous_error = error;                                 //UPDATING THE ERROR VALUE
    //mspeed = map(PID, -243.75, 243.75, 0, 255);           //Mapping PID values to a range of values to control motor speed
    //mspeed = constrain(mspeed, 0, 255);
    //Serial.println(mspeed);
 
      
    if(Gyr_rawY<setpoint-5)
      {
       mspeed = map(b, abs(a), 1023, 0, 255);           //Mapping PID values to a range of values to control motor speed
       mspeed = constrain(mspeed, 0, 255);
       foward();
      }
    if(Gyr_rawY>setpoint+5)
      {
       mspeed = map(Gyr_rawY, a, 1023, 0, 255);           //Mapping PID values to a range of values to control motor speed
       mspeed = constrain(mspeed, 0, 255);       
       back();
      }
    if(Gyr_rawY<=setpoint+5 && Gyr_rawY>=setpoint-5)
    halt();
    delay(50);
}

//MOVEMENT FUNCTION
void foward()
{
    Serial.println("avance ta race");
    Serial.print("Angle:     ");
    Serial.println(Gyr_rawY);
    //digitalWrite(motorL1, HIGH);
    digitalWrite(motorL1, HIGH);
    analogWrite(motorL2, LOW);
    //digitalWrite(motorR1, HIGH);
    digitalWrite(motorR1, HIGH);
    analogWrite(motorR2, LOW);
    //setMotorSpeed(correctionAngle)
    analogWrite(pinWheelREnable, mspeed);
    analogWrite(pinWheelLEnable, mspeed);
    Serial.print("mspeed     ");
    Serial.println(mspeed);
    Serial.print("b     ");
    Serial.println(b);
}
void back()
{
    Serial.println("recule ta mere");
    Serial.print("Angle:     ");
    Serial.println(Gyr_rawY);
    analogWrite(motorL1, LOW);
    //digitalWrite(motorL2, HIGH);
    digitalWrite(motorL2, HIGH);
    analogWrite(motorR1, LOW);
    //digitalWrite(motorR2, HIGH);
    digitalWrite(motorR2, HIGH);
    //setMotorSpeed(correctionAngle)
    analogWrite(pinWheelREnable, mspeed);
    analogWrite(pinWheelLEnable, mspeed);
    Serial.print("mspeed:     ");
    Serial.println(mspeed);
    Serial.print("a     ");
    Serial.println(a);
}
void halt()
{
    Serial.println("stop");
    Serial.print("Angle:     ");
    digitalWrite(motorL1, LOW);
    digitalWrite(motorL2, LOW);
    digitalWrite(motorR1, LOW);
    digitalWrite(motorR2, LOW);
    Serial.print("mspeed     ");
    Serial.println(mspeed);

}
